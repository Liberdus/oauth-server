# OAuth Server

A lightweight OAuth server for handling Google OAuth flows with long polling support. Built with Fastify and TypeScript.

## Features

- Google OAuth 2.0 implicit flow
- Long polling for token retrieval
- Session management with automatic TTL
- CORS support for web clients
- TypeScript for type safety
- Fast and lightweight with Fastify

## Architecture

### Flow Diagram

```
Client                    OAuth Server              Google OAuth
  |                            |                          |
  |-- Generate sessionId       |                          |
  |                            |                          |
  |-- Open popup ------------→ |                          |
  |   /auth?sessionId=xxx      |                          |
  |                            |                          |
  |                            |-- Redirect -----------→  |
  |                            |                          |
  |                            |                    [User approves]
  |                            |                          |
  |                            |←-- Redirect /done -------|
  |                            |    #access_token=yyy     |
  |                            |                          |
  |                            |←-- POST /auth/save ------|
  |                            |    {token, sessionId}    |
  |                            |                          |
  |-- Poll /auth/poll?sessionId|                          |
  |    (long poll until token) |                          |
  |                            |                          |
  |←-- Return token -----------|                          |
```

## Setup

### Prerequisites

- Node.js 18+
- npm or yarn
- Google Cloud Console project with OAuth credentials

### Installation

1. Clone the repository and install dependencies:

```bash
npm install
```

2. Configure environment variables:

```bash
cp .env.example .env
```

Edit `.env` and add your Google OAuth credentials:

```env
PORT=3000
SERVER_URL=http://localhost:3000
GOOGLE_CLIENT_ID=your-client-id.apps.googleusercontent.com
ALLOWED_ORIGINS=http://localhost:3000,http://localhost:5173
```

### Google OAuth Setup

1. Go to [Google Cloud Console](https://console.cloud.google.com/)
2. Create a new project or select existing one
3. Enable Google Drive API
4. Go to **Credentials** → **Create Credentials** → **OAuth 2.0 Client ID**
5. Application type: **Web application**
6. Add authorized redirect URIs:
   - `http://localhost:3000/done` (development)
   - `https://your-domain.com/done` (production)
7. Copy the **Client ID** to your `.env` file

### Running the Server

Development mode with hot reload:

```bash
npm run dev
```

Build for production:

```bash
npm run build
npm start
```

## API Documentation

### 1. Start OAuth Flow

**Endpoint:** `GET /auth`

**Query Parameters:**
- `sessionId` (required): UUID v4 generated by client
- `provider` (required): OAuth provider (currently only `google`)

**Example:**
```javascript
const sessionId = crypto.randomUUID();
window.open(`http://localhost:3000/auth?sessionId=${sessionId}&provider=google`);
```

**Response:** Redirects to Google OAuth consent page

---

### 2. OAuth Callback

**Endpoint:** `GET /done`

**Description:** OAuth provider redirects here after user approval. This page extracts the token from URL fragment and sends it to the server.

**Note:** This is handled automatically by the browser popup. No manual interaction needed.

---

### 3. Save Token

**Endpoint:** `POST /auth/save`

**Body:**
```json
{
  "sessionId": "uuid-v4-string",
  "token": "access-token-from-google"
}
```

**Response:**
```json
{
  "success": true
}
```

**Note:** This is called automatically by the `/done` page.

---

### 4. Poll for Token

**Endpoint:** `GET /auth/poll`

**Query Parameters:**
- `sessionId` (required): The session ID used in `/auth`

**Description:** Long poll endpoint that waits up to 60 seconds for token to become available.

**Example:**
```javascript
async function pollForToken(sessionId) {
  const response = await fetch(
    `http://localhost:3000/auth/poll?sessionId=${sessionId}`
  );
  const data = await response.json();
  return data.token;
}
```

**Success Response (200):**
```json
{
  "success": true,
  "token": "ya29.a0AfH6SMC...",
  "sessionId": "uuid-v4-string"
}
```

**Timeout Response (408):**
```json
{
  "error": "Request timeout. Token not available yet.",
  "sessionId": "uuid-v4-string"
}
```

**Client should retry polling if timeout occurs.**

---

### 5. Health Check

**Endpoint:** `GET /health`

**Response:**
```json
{
  "status": "ok",
  "timestamp": "2025-12-09T...",
  "uptime": 1234.56
}
```

## Client Integration Example

### Web Client (JavaScript)

```javascript
class OAuthClient {
  constructor(serverUrl) {
    this.serverUrl = serverUrl;
  }

  async authenticate(provider = 'google') {
    // Generate session ID
    const sessionId = crypto.randomUUID();

    // Open OAuth popup
    const width = 500;
    const height = 600;
    const left = window.screen.width / 2 - width / 2;
    const top = window.screen.height / 2 - height / 2;

    window.open(
      `${this.serverUrl}/auth?sessionId=${sessionId}&provider=${provider}`,
      'oauth',
      `width=${width},height=${height},left=${left},top=${top}`
    );

    // Poll for token
    return this.pollForToken(sessionId);
  }

  async pollForToken(sessionId, maxRetries = 5) {
    for (let i = 0; i < maxRetries; i++) {
      try {
        const response = await fetch(
          `${this.serverUrl}/auth/poll?sessionId=${sessionId}`
        );

        if (response.ok) {
          const data = await response.json();
          return data.token;
        }

        if (response.status === 408) {
          // Timeout, retry
          continue;
        }

        throw new Error(`Poll failed: ${response.status}`);
      } catch (error) {
        console.error('Poll error:', error);
        if (i === maxRetries - 1) throw error;
      }
    }

    throw new Error('Failed to get token after max retries');
  }
}

// Usage
const oauthClient = new OAuthClient('http://localhost:3000');

document.getElementById('login-btn').addEventListener('click', async () => {
  try {
    const token = await oauthClient.authenticate('google');
    console.log('Access token:', token);
    // Use token for Google Drive API calls
  } catch (error) {
    console.error('Authentication failed:', error);
  }
});
```

## Configuration

### Environment Variables

| Variable | Description | Default |
|----------|-------------|---------|
| `PORT` | Server port | `3000` |
| `HOST` | Server host | `0.0.0.0` |
| `NODE_ENV` | Environment | `development` |
| `LOG_LEVEL` | Logging level | `info` |
| `SERVER_URL` | Public server URL | `http://localhost:3000` |
| `ALLOWED_ORIGINS` | CORS allowed origins | `*` |
| `GOOGLE_CLIENT_ID` | Google OAuth client ID | (required) |

### Cache Configuration

Sessions and tokens are stored in memory with a 10-minute TTL (Time To Live). This can be modified in [src/server.ts:8](src/server.ts#L8):

```typescript
const cache = new NodeCache({ stdTTL: 600, checkperiod: 120 });
```

## Security Considerations

1. **HTTPS in Production**: Always use HTTPS in production to prevent token interception
2. **CORS Configuration**: Restrict `ALLOWED_ORIGINS` to your specific domains
3. **Client ID**: Never expose `GOOGLE_CLIENT_SECRET` (not needed for implicit flow)
4. **Session TTL**: Short TTL (10 minutes) reduces risk of session hijacking
5. **UUID Validation**: Server validates sessionId format to prevent injection

## Production Deployment

### Docker

```dockerfile
FROM node:18-alpine

WORKDIR /app

COPY package*.json ./
RUN npm ci --only=production

COPY . .
RUN npm run build

EXPOSE 3000

CMD ["npm", "start"]
```

### Environment Variables

Set these in your production environment:

```env
NODE_ENV=production
SERVER_URL=https://oauth.yourdomain.com
ALLOWED_ORIGINS=https://yourdomain.com,https://app.yourdomain.com
GOOGLE_CLIENT_ID=your-production-client-id
```

## License

MIT
